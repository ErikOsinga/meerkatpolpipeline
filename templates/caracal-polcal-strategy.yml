schema_version: 1.0.3

general:
  prefix: caracalpipelinerun
  msdir: '/will/be/replaced/with/path/to/ms.parent'
  # where to find caracal files, flagging strategy etc
  input: '/net/rijn9/data2/osinga/meerkatBfields/caracal_files/'
  final_report: true
  backend: singularity

getdata:
  dataid: ['will-be-replaced-with-ms.stem']

obsconf:
  target:
    - 'will-be-replaced-by-targetfield'
  fcal:
    - 'will-be-replaced-'
  bpcal:
    - 'will-be-replaced-'
  gcal:
    - 'will-be-replaced-'
  xcal:
    - 'will-be-replaced-'
  refant: 'm024'

transform:
  enable: true
  field: calibrators
  label_out: cal
  split_field:
    enable: true
    col: data

prep:
  enable: true
  label_in: cal
  field: calibrators
  specweights:
    enable: true
    mode: uniform

flag:
  enable: true
  field: calibrators
  label_in: cal
  flag_shadow:
    enable: true
  flag_autocorr:
    enable: true
  flag_rfi:
    enable: true
    flagger: tfcrop

crosscal:
  enable: true
  uvrange: '>150'
  label_in: cal
  label_cal: 1kgb
  set_model:
    enable: true
    meerkat_skymodel: false
    # set crystalball_skymodel to true for UHF band
    # TODO: do we want to do this for L-band as well?
    meerkat_crystalball_skymodel: true
    # VERY IMPORTANT, DEFAULTS TO L-band
    meerkat_band: 'L'
  primary:
    reuse_existing_gains: false
    order: KGBAKGBK
    combine: ["","","",null,"", "", "scan","scan"]
    solint: [inf, inf, inf, null, 60s, 60s, inf,inf]
    calmode: [a, ap, ap, null, a, ap, ap, a]
    b_fillgaps: 70
    plotgains: true
  secondary:
    reuse_existing_gains: false
    order: GAF
    apply: KB
    combine: ["",null,""]
    solint: [inf,null,inf]
    calmode: [ap,null,ap]
    plotgains: true
  apply_cal:
    applyto:
      - gcal
      - bpcal
      - xcal

# first polcal strategy is when you have a good unpolarized calibrator and 3C138 or 3C286 for the phase and delay
polcal:
  enable: true
  label_in: cal
  label_cal: 1pcal
  otfcal:
    enable: true
    label_cal: 1kgb
  extendflags: True
  # IMPORTANT! Should be set to -90 if visibilities straight from meerkat archive
  # we set to zero because pipeline does feed angle rotation in preprocess step
  feed_angle_rotation: '0'
  uvrange: '>150'
  reuse_existing_tables: false
  pol_calib: xcal
  ##### NOTE! Changed to fcal
  leakage_calib: fcal
  set_model_leakage:
    enable: true
    meerkat_skymodel: true
  set_model_pol:
    enable: true
    # only allowed in the polimager branch!!!!!!!
    # suggested to install caracal from github and switch to that branch
    nrao_model: false
    taylor_legodi_model: true
  gain_solint: '60s'
  time_solint: 'inf'
  plotgains: true
  apply_pcal: true
  applyto:
    - gcal
    - bpcal
    - xcal


# Now add transform worker to apply solutions
# and split target field from MS
# and average from 0.2 MHz a factor 4 (!!) in freq
# and to 16 seconds, a factor 2 in time.
transform__2:
  enable: true
  label_out: corr
  field: target
  split_field:
    enable: true
    col: corrected
    nthreads: 8
    time_avg: '16s'
    chan_avg: 4
    otfcal:
      enable: true
      label_cal: 1kgb
      label_pcal: 1pcal

prep__2:
  enable: true
  label_in: corr
  field: target
  specweights:
    enable: true
    mode: uniform

flag__2:
  enable: true
  field: target
  label_in: corr
#  rewind_flags:
#    enable: true
  flag_spw:
    enable: true
  flag_rfi:
    enable: true
    col: DATA
    flagger: aoflagger
    aoflagger:
      strategy: firstpass_QUV.rfis


# leaving this here if we ever want to run caracal selfcal
# but its surpassed greatly by facetselfcal
selfcal:
  enable: false
  img_npix: 8192
  img_cell: 3.1
  img_robust: 0.5
  cal_timeslots_chunk: -1
  img_nrdeconvsubimg: 4
  image:
    enable: true
    absmem: 450
    ncpu_img: 94
  calibrate:
    enable: true
    gsols_timeslots: [6]
  transfer_model:
    enable: false

    
    
    

